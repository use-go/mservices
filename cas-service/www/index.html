<script src="https://cdn.bootcdn.net/ajax/libs/fetch/3.6.2/fetch.min.js"></script>
<script>
var client_id = '000000'
var client_secret = '999999'
var authorize_url = 'http://192.168.202.128:8080/cas/oauth2/authorize'
var token_url = 'http://192.168.202.128:8080/cas/oauth2/token'
var grant_type = 'authorization_code'
var code_verifier = 's256example'
var response_type = 'code'
var redirect_uri = window.location.href.replaceAll(window.location.search, '')
var code_challenge = 'Qn3Kywp0OiU4NK_AFzGPlmrcYJDJ13Abj_jdL08Ahg8='
var code_challenge_method = 'S256'
var state = 'xyz'
var scope = 'all'

function setCookie(name, value) {
    var hour = 8; 
    var exp = new Date(); 
    exp.setTime(exp.getTime() + hour*60*60*1000); 
    document.cookie = name + "="+ escape(value) + ";expires=" + exp.toGMTString()+";path=/"; 
}

function getCookie(name) {
    var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");
    if(arr=document.cookie.match(reg))
        return unescape(arr[2]);
    else
        return null;
}

function getQueryString(name) {
  var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
  var r = window.location.search.substr(1).match(reg);
  if (r != null) {
    return unescape(r[2]);
  }
  return null;
}

function urlDelParams(name) {
  var loca = window.location
  var baseUrl = loca.origin + loca.pathname + '?'
  var query = loca.search.substr(1)
  if (query.indexOf(name) > -1) {
    var obj = {}
    var arr = query.split('&')
    for (var i = 0; i < arr.length; i++) {
      arr[i] = arr[i].split('=')
      obj[arr[i][0]] = arr[i][1]
    }
    delete obj[name]
    var url =
      baseUrl +
      JSON.stringify(obj)
        .replace(/[\"\{\}]/g, '')
        .replace(/\:/g, '=')
        .replace(/\,/g, '&')
    return url
  }
}

function request(url, params = {}) {
    return fetch(url, Object.assign({ headers:{ 'Authorization': getCookie('Authorization') } }, params)).then(function(response) {
        if (response.status === 401) {
            window.location.href= authorize_url +"?response_type=" + response_type + "&state="+ state + "&redirect_uri="+encodeURIComponent(redirect_uri)+"&code_challenge=" + encodeURIComponent(code_challenge) + "&code_challenge_method="+code_challenge_method+"&scope="+scope+"&client_id="+client_id
            throw new Error('unauthorized request') 
        }
        return response.json()
    })
}

function updateInfo() {
    request('http://192.168.202.128:8080/helloworld/updateInfo').then(function(json) {
        var body = document.body;
        var div = document.createElement("div");
        div.innerHTML = JSON.stringify(json);
        document.body.appendChild(div);
    }).catch(function(ex) {
        console.error(ex)
    })
}

window.onload = function() {
    var code = getQueryString("code")
    if (!!code) {
        // remove code for safty
        history.pushState(null,document.title,urlDelParams('code'));
        // fetch token
        if (!getCookie('Authorization')) {
            var data = new URLSearchParams()
            data.append('grant_type', grant_type)
            data.append('client_id', client_id)
            data.append('code_verifier', code_verifier)
            data.append('client_secret', client_secret)
            data.append('redirect_uri', redirect_uri)
            data.append('code', code)
            return fetch(token_url, { method: 'POST', body: data }).then(function(response) {
                return response.json()
            }).then(function(json) {
                if (!!json.access_token) {
                    setCookie('Authorization', 'Bearer ' + json.access_token)
                    return
                }
            })
        }
    }
}
</script>

<a href="javascript:void(0)" onclick="updateInfo()">http://192.168.202.128:8080/helloworld/updateInfo</a>
