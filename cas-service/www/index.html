<script src="https://cdn.bootcdn.net/ajax/libs/fetch/3.6.2/fetch.min.js"></script>
<script>
function setCookie(name,value) { 
    var hour = 8; 
    var exp = new Date(); 
    exp.setTime(exp.getTime() + hour*60*60*1000); 
    document.cookie = name + "="+ escape (value) + ";expires=" + exp.toGMTString()+";path=/"; 
}
function getQueryString(name) {
  var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
  var r = window.location.search.substr(1).match(reg);
  if (r != null) {
    return unescape(r[2]);
  }
  return null;
}

var url = 'http://127.0.0.1:8080/helloworld/updateInfo'
var grant_type = 'authorization_code'
var client_id = '000000'
var code_verifier = 's256example'
var client_secret = '999999'
var response_type = 'code'
var redirect_uri = window.location.href.replaceAll(window.location.search, '')
fetch(url, { credentials: 'include' }).then(function(response) {
    if (response.status === 401) {
        var code = getQueryString("code") 
        if(!code) {
            window.location.href="http://127.0.0.1:8080/cas/oauth2/authorize?response_type=code&state=xyz&redirect_uri="+encodeURIComponent(redirect_uri)+"&code_challenge=" + encodeURIComponent("Qn3Kywp0OiU4NK_AFzGPlmrcYJDJ13Abj_jdL08Ahg8=") + "&code_challenge_method=S256&scope=all&client_id=000000"
            return null
        } else {
            var data = new URLSearchParams()
            data.append('grant_type', grant_type)
            data.append('client_id', client_id)
            data.append('code_verifier', code_verifier)
            data.append('client_secret', client_secret)
            data.append('redirect_uri',redirect_uri)
            data.append('code', code)
            return fetch('http://127.0.0.1:8080/cas/oauth2/token', {
                method: 'POST',
                body: data
            }).then(function(response) {
                return response.json()
            }).then(function(json) {
                setCookie('micro-token', json.access_token)
                return fetch(url, { credentials: 'include' }).then(function(response) { return response.json() })
            })
        }
    }
    return response.json()
}).then(function(json) {
    document.body.innerHTML = JSON.stringify(json)
}).catch(function(ex) {
    document.body.innerHTML = JSON.stringify(ex)
})
</script>