<script src="https://cdn.bootcdn.net/ajax/libs/fetch/3.6.2/fetch.min.js"></script>
<script>
var url = 'http://127.0.0.1:8080/helloworld/updateInfo'
var grant_type = 'authorization_code'
var client_id = '000000'
var code_verifier = 's256example'
var client_secret = '999999'
var response_type = 'code'
var redirect_uri = window.location.href.replaceAll(window.location.search, '')
var authorize_url = 'http://127.0.0.1:8080/cas/oauth2/authorize'
var code_challenge = 'Qn3Kywp0OiU4NK_AFzGPlmrcYJDJ13Abj_jdL08Ahg8='
var code_challenge_method = 'S256'
var token_url = 'http://127.0.0.1:8080/cas/oauth2/token'

function setCookie(name,value) { 
    var hour = 8; 
    var exp = new Date(); 
    exp.setTime(exp.getTime() + hour*60*60*1000); 
    document.cookie = name + "="+ escape (value) + ";expires=" + exp.toGMTString()+";path=/"; 
}

function getQueryString(name) {
  var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
  var r = window.location.search.substr(1).match(reg);
  if (r != null) {
    return unescape(r[2]);
  }
  return null;
}

function request(url, params = { credentials: 'include' }) {
    return fetch(url, params).then(function(response) {
        if (response.status === 401) {
            var code = getQueryString("code") 
            if(!code) {
                window.location.href= authorize_url +"?response_type=code&state=xyz&redirect_uri="+encodeURIComponent(redirect_uri)+"&code_challenge=" + encodeURIComponent(code_challenge) + "&code_challenge_method="+code_challenge_method+"&scope=all&client_id="+client_id
            } else {
                var data = new URLSearchParams()
                data.append('grant_type', grant_type)
                data.append('client_id', client_id)
                data.append('code_verifier', code_verifier)
                data.append('client_secret', client_secret)
                data.append('redirect_uri',redirect_uri)
                data.append('code', code)
                return fetch(token_url, { method: 'POST', body: data }).then(function(response) {
                    return response.json()
                }).then(function(json) {
                    setCookie('micro-token', json.access_token)
                    return request(url,params)
                })
            }
        }
        return response.json()
    })
}

request(url).then(function(json) {
    document.body.innerHTML = JSON.stringify(json)
}).catch(function(ex) {
    document.body.innerHTML = JSON.stringify(ex)
})

</script>